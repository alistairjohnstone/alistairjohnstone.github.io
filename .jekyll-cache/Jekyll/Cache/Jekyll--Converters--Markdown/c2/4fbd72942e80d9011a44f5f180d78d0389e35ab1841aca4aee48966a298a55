I"ø!<p>Hereâ€™s how you can use Facebookâ€™s open-source Prophet library in Google Sheets to create  accurate time-series predictions using simple and intuitive parameters.</p>

<amp-img src="/assets/images/sheets-prophet.png" width="1280" height="720" layout="responsive"></amp-img>

<p>This is a proof-of-concept solution for Prophet forecasting in Google Sheets. You may want to build on this to include additional parameters that will give you greater control over the forecast model.</p>

<h2 id="what-is-facebook-prophet">What is Facebook Prophet?</h2>

<p>Prophet is open source software released by Facebookâ€™s Core Data Science team. It is a procedure for forecasting time series data and works best with time series that have strong seasonal effects and several seasons of historical data. It is available for download on CRAN and PyPI.</p>

<h2 id="overview">Overview</h2>

<p>Hereâ€™s an overview of the data flow for this solution:</p>

<p>IMAGE OF DATA FLOW</p>

<p>As you can see itâ€™s pretty straightforward, the user fills in the custom function and those variables are sent off to our Python script for forecasting and the results returned to Google Sheets.</p>

<h2 id="step-1-lets-build-our-own-api">Step 1: Letâ€™s build our own API</h2>

<p>Weâ€™ll be building our own API using FastAPI, which is a modern, fast (high-performance), web framework for building APIs with Python. This will take parameters from the Google Sheets function and do all the forecasting in the background with Facebook Prophet:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from fastapi import FastAPI
from pydantic import BaseModel
import pandas as pd
from fbprophet import Prophet

class Data(BaseModel):
    length: int
    ds: list
    y: list
    model: str
    changepoint: float = 0.5
    daily: bool = False
    weekly: bool = False
    annual: bool = False
    upper: float = None
    lower: float = 0.0
    national_holidays: str = None

app = FastAPI()

@app.post("/prophecise/")
async def create_item(data: Data):

    # Create df from base model
    df = pd.DataFrame(list(zip(data.ds, data.y)), columns =['ds', 'y'])

    # Add the cap and floor to df for logistic model
    if data.model == "logistic":
        df['y'] = 10 - df['y']
        df['cap'] = data.upper
        df['floor'] = data.lower

    # make basic prediction
    m = Prophet(growth=data.model,
                changepoint_prior_scale=data.changepoint,
                weekly_seasonality=data.weekly,
                daily_seasonality=data.daily,
                yearly_seasonality=data.annual
                )
    
    # Add national holidays
    if data.national_holidays is not None:
        m.add_country_holidays(country_name=data.national_holidays)
    
    # Fit data frame
    m.fit(df)

    # Create data frame for future
    future = m.make_future_dataframe(periods=data.length)

    # Add the cap and floor to future for logistic model
    if data.model == "logistic":
        future['cap'] = 6
        future['floor'] = 1.5

    # Prophecise!
    forecast = m.predict(future)

    # Print values
    print(list(forecast[['ds']].values))

    # Return results
    # {'ds': forecast[['ds']], 'yhat': forecast[['yhat']], 'yhat_lower': forecast[['yhat_lower']], 'yhat_upper': forecast[['yhat_upper']] }
    return [forecast[['ds']], forecast[['yhat']], forecast[['yhat_lower']], forecast[['yhat_upper']]]
</code></pre></div></div>
<h2 id="upload-your-api-app-to-google-cloud-platform">Upload your API app to Google Cloud Platform</h2>
<p>Weâ€™ll be running our API on Google Cloud Platform using Cloud Run, which is a fully managed compute platform for deploying and scaling containerized applications quickly and securely.</p>

<p>So first of all we need to containerize our app using Docker. If youâ€™re not familiar with Docker then Iâ€™d recommend taking a look at their documentation. To do this youâ€™ll need to create a Dockerfile:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
FROM tiangolo/uvicorn-gunicorn-fastapi:python3.7

COPY ./app /app

WORKDIR /app

RUN apt-get -y update  &amp;&amp; apt-get install -y \
  python3-dev \
  apt-utils \
  python-dev \
  build-essential \
&amp;&amp; rm -rf /var/lib/apt/lists/*

RUN pip install --upgrade setuptools
RUN pip install cython
RUN pip install numpy
RUN pip install pandas
RUN pip install matplotlib
RUN pip install pystan
RUN pip install fbprophet
RUN pip install fastapi
RUN pip install pydantic
</code></pre></div></div>

<p>Once youâ€™ve deployed to Cloud Run, youâ€™ll be given a URL which is used as the API endpoint, which we can use in our Apps Script.</p>

<p>IMAGE OF CLOUDRUN ENDPOINT</p>

<h2 id="finally-we-use-apps-script-to-call-our-api">Finally, we use Apps Script to call our API</h2>
<p>Now weâ€™re ready to set up our custom function for Sheets in Apps Script. Weâ€™ll take the user inputs from our custom function and send these on to our API for forecasting.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/**
 * Forecast data using Facebook Prophet. Upper and Lower bounds are only required when using the logistic regression model. More information can be found at https://facebook.github.io/prophet/
 *
 * @param {A2:A150} dates - Select the pre-forecast date range as a STRING
 * @param {B2:B150} values - Select the pre-forecast metric values as a STRING
 * @param {14} forecastLength - How many days would you like to forecast?
 * @param {"linear"} model - "linear" or "logistic"
 * @param {"True"} annual - Does data contain annual seasonality? true or false
 * @param {"False"} weekly - Does data contain weekly seasonality? true or false
 * @param {"False"} daily - Does data contain daily seasonality? true or false
 * @param {""} upper - Select the pre-forecast date range (Only required for logistic regression model)
 * @param {""} lower - Select the pre-forecast date range (Only required for logistic regression model)
 * @param {"UK"} nationalHolidays - ISO of country you'd like to add national holidays for e.g. "UK" 
 * @return Facebook Prophet Forecast.
 * @customfunction
 */

function prophecise(dates, values, forecastLength, model, annual, weekly, daily, nationalHolidays, upper, lower) {
  
	//  API endpoint
	var url = 'YOUR_CLOUD_RUN_URL';
  
	// Format the date and values  
	var dates = SpreadsheetApp.getActiveSpreadsheet().getRange(dates).getDisplayValues().join().split(','),
        dates = dates.filter(String),
        values = SpreadsheetApp.getActiveSpreadsheet().getRange(values).getDisplayValues().join().split(','),
        values = values.filter(String),
        formattedDates = dates.join().split(','),
        formattedMetrics = values.join().split(','),
        preforecastData = {
		"length": forecastLength,
		"ds": formattedDates,
		"y": formattedMetrics,
		"model": model.toLowerCase(),
		"annual": annual.toString().toLowerCase(),
		"weekly": weekly.toString().toLowerCase(),
		"daily": daily.toString().toLowerCase(),
		"upper": upper,
		"lower": lower,
		"national_holidays": nationalHolidays
	};
  
	// Add the pre-forecast data to the payload
	var options = {
		'method': 'post',
		'contentType': 'json',
		'payload': JSON.stringify(preforecastData)
	};
  
	// Call prophecise API
	var response = UrlFetchApp.fetch(url, options);
  
	// Return forecast result
	var json = JSON.parse(response)
	var dates = Object.values(json[0].ds);
	var forecast = Object.values(json[1].yhat);
	var forecastresult = [];
	dates.forEach(function(date) {
		forecastresult.push([date]);
	});
	forecast.forEach(function(yhat, index) {
		forecastresult[index].push(yhat);
	})
	forecastresult.splice(0, 0, ["Date", "Forecast"]);
	return forecastresult;
  
}
</code></pre></div></div>

<h2 id="using-the-formula-in-google-sheets">Using the formula in Google Sheets</h2>
<p>Iâ€™ve been using the formula to forecast Google Analytics data in Google Sheets using the Google Analytics add-on and our custom function. So for example, the following function would take the dates from column A and the metrics in column B and return a 30 day forecast that takes in to account national holidays in the UK:</p>

<p><code class="language-plaintext highlighter-rouge">=prophecise("A2:A","B2:B",30,"linear",true,false,false,"UK")</code></p>

<p>In this example I then used the Prophet forecasts in a Google Data Studio dashboard to show predicted trends for KPIs.</p>

<p>Hopefully you found this post useful and it has inspired you to start using your own Python/R functions in Google Sheets, the possibilities are endless!</p>

:ET